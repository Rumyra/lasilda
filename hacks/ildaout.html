<html>
<body>

  <canvas id="canvas" width="640" height="480" style="border:1px solid #000000;">
  </canvas>

  <script>
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!window.AudioContext) {
    console.log("No window.AudioContext - serial_audio disabled");
  }
  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
  if (!navigator.getUserMedia) {
    console.log("No navigator.getUserMedia - serial_audio disabled");
  }

  var userMediaStream;
  var context = new AudioContext();
  var inputNode = context.createScriptProcessor(1024, 2/*in*/, 2/*out*/);
  var pattern = [[0,0]];
  window.dontGarbageCollectMePlease = inputNode;
  //context.sampleRate
var pos = 0;

/*var n = 0|(i*pattern.length/dx.length);
dx[i] = pattern[n][0];
dy[i] = pattern[n][1];*/

var library = [
  {
    "name" : "Circle wave",
    "handler" : function() {
      return function(e) {
        for (var i=0;i<e.x.length;i++) {
          var s = (e.l[i]+e.r[i])/2;
          var a = Math.PI*i*2 / e.x.length;
          e.x[i] = Math.sin(a*2)*(1+s)/2;
          e.y[i] = Math.cos(a*2)*(1+s)/2;
        }
      }
    }
  },
  {
    "name" : "Twisty thing",
    "handler" : function() {
      var px = 0;
      var py = 0;
      return function(e) {
        for (var i=0;i<e.x.length;i++) {
          e.x[i] = Math.sin(px);
          e.y[i] = Math.cos(py);
          px += (1.2+Math.sin(px/3987))/50;
          py += (1.2+Math.cos(py/4000))/50;
        }
      }
    }
  },
  {
    "name" : "Line wave",
    "handler" : function() {
      var ang = 0;
      return function(e) {
        ang += 0.1;
        var dx = Math.cos(ang);
        var dy = Math.sin(ang);
        var ex = -dy;
        var ey = dx;
        var l = e.x.length;
        for (var i=0;i<l;i++) {
          var n = (((i>=(l/2)) ? (l-i) : i) * 4 / l) - 1;
          var s = e.l[i]+e.r[i];
          e.x[i] = dx*n + ex*s;
          e.y[i] = dy*n + ey*s;
        }
      }
    }
  },
  {
    "name" : "Line wave",
    "handler" : function() {
      var ang = 0;
      var b = [];
      for (var i=0;i<8;i++) {
        var r = Math.random()*Math.PI*2;
        var s = 1+Math.random();
        b.push({
          x : 1.5*(Math.random()-0.5),
          y : 1.5*(Math.random()-0.5),
          dx : Math.cos(r)*s,
          dy : Math.sin(r)*s,
          s : (Math.random()+1)/5
        });
      }
      return function(e) {
        var p = 0;
        var l = e.x.length / b.length;
        var d = 0.01;
        b.forEach(function(s) {
          s.x += s.dx*d;
          s.y += s.dy*d;
          if (s.x+s.s>1) s.dx=-Math.abs(s.dx);
          if (s.x-s.s<-1) s.dx=Math.abs(s.dx);
          if (s.y+s.s>1) s.dy=-Math.abs(s.dy);
          if (s.y-s.s<-1) s.dy=Math.abs(s.dy);
          for (var i=0;i<l;i++) {
            var a = Math.PI*i*2 / l;
            e.x[p] = Math.cos(a)*s.s + s.x;
            e.y[p] = Math.sin(a)*s.s + s.y;
            p++;
          }
        });
      }
    }
  },
]

var handler = library[library.length-1].handler();

inputNode.onaudioprocess = function(e) {
  var il = e.inputBuffer.getChannelData(0);
  var ir = e.inputBuffer.getChannelData(1);
  var dx = e.outputBuffer.getChannelData(0);
  var dy = e.outputBuffer.getChannelData(1);
  handler({l:il, r:ir, x:dx, y:dy});
  setTimeout(function() {
    preview(dx, dy);
  }, 1);
}

function start() {
  navigator.getUserMedia({
    video:false,
    audio:{
      mandatory:[],
      optional:[{sampleRate:44100}]
    }
  }, function(stream) {
    userMediaStream = stream;
    var inputStream = context.createMediaStreamSource(stream);
    inputStream.connect(inputNode);
    inputNode.connect(context.destination);
  }, function(e) {
    console.log('serial_audio: getUserMedia error', e);
  });
}

start();

var c = document.getElementById("canvas");
var ctx = c.getContext("2d");

c.addEventListener("mousedown", function(e) {
  var r = 0|(Math.random()*library.length);
  if (r>=library.length) r=library.length-1;
  handler = library[r].handler();
});

/*var lastX, lastY;
c.addEventListener("mousedown", function(e) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  pattern = [];
  lastX = e.clientX;
  lastY = e.clientY;
  pattern.push([2*e.clientX/canvas.width - 1, 2*e.clientY/canvas.height - 1]);
}, false);

c.addEventListener("mousemove", function(e) {
  if (!e.buttons) return;
  ctx.beginPath();
  ctx.moveTo(lastX,lastY);
  ctx.lineTo(e.clientX,e.clientY);
  ctx.stroke();
  lastX = e.clientX;
  lastY = e.clientY;
  pattern.push([2*e.clientX/canvas.width - 1, 2*e.clientY/canvas.height - 1]);
}, false);*/

function preview(dx,dy) {
  ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
  ctx.strokeStyle = "#3FFF3F";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  if (dx.length==0) return;
  ctx.beginPath();
  ctx.moveTo((dx[0]+1)*canvas.width/2, (dy[0]+1)*canvas.height/2);
  for (var i=1;i<dx.length;i++)
    ctx.lineTo((dx[i]+1)*canvas.width/2, (dy[i]+1)*canvas.height/2);
  ctx.stroke();
}

  </script>
</body>
</html>
